rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================================
    // üîß Helpers
    // ================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // ================================
    // üî• POK√âDEX ADMIN
    // ================================

    // Esp√©cies base dos Pok√©mon (Biblioteca)
    match /pokemonSpecies/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Configura√ß√µes mut√°veis de venda dos itens (loja)
    match /itemsConfig/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Configura√ß√µes por vers√£o do jogo
    match /pokedexConfig/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Movimentos (cat√°logo geral de golpes)
    match /moves/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Learnset por esp√©cie
    match /pokemonMoves/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Habilidades
    match /abilities/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // Itens globais (Cat√°logo)
    match /items/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // ================================
    // üî• ELODEX ‚Äî USU√ÅRIOS
    // ================================
    match /users/{uid} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // Hist√≥rico financeiro principal (por usu√°rio)
    match /users/{uid}/transactions/{txId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // ‚úÖ collectionGroup(transactions) para admin
    match /{path=**}/transactions/{txId} {
      allow read: if isAdmin();
    }

    // Time principal
    match /users/{uid}/team/{slotId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // Box de armazenamento
    match /users/{uid}/box/{boxEntryId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // Invent√°rio de itens do jogador
    match /users/{uid}/inventory/{itemId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // Hist√≥rico econ√¥mico
    match /users/{uid}/economy/{eventId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // Hist√≥rico por Pok√©mon
    match /users/{uid}/pokemonHistory/{histId} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    // ================================
    // üî• INST√ÇNCIAS DE POK√âMON
    // ================================
    match /pokemonInstances/{pokeInstanceId} {
      allow read: if (isSignedIn() && isSelf(resource.data.ownerId)) || isAdmin();
      allow write: if (isSignedIn() && isSelf(request.resource.data.ownerId)) || isAdmin();
    }

    // ================================
    // üî• ESTAT√çSTICAS
    // ================================
    match /users_stats/{uid} {
      allow read:  if isSelf(uid) || isAdmin();
      allow write: if isSelf(uid) || isAdmin();
    }

    match /pokemon_stats/{pokeId} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    // ================================
    // üî• LOGS / MISS√ïES / EVENTOS
    // ================================

    match /encounters_log/{id} {
      allow read:  if false;
      allow write: if isSignedIn();
    }

    // ‚úÖ CONFIGURA√á√ÉO ADMIN (NOVO) ‚Äî Miss√µes & Eventos (Admin)
    // Cole√ß√£o unificada apenas para CONFIGURA√á√ÉO
    // (n√£o √© execu√ß√£o de jogo)
    match /missionsEvents/{id} {
      allow read:  if isAdmin();
      allow write: if isAdmin();
    }

    // Cole√ß√µes antigas (se voc√™ ainda usa em algum lugar)
    match /missions/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    match /events/{id} {
      allow read:  if isSignedIn();
      allow write: if isAdmin();
    }

    match /audit_logs/{id} {
      allow read:  if isAdmin();
      allow write: if isAdmin();
    }

    // ================================
    // üî• PRESEN√áA (futuro)
    // ================================
    match /presence/{uid} {
      allow read:  if isSignedIn();
      allow write: if false;
    }
  }
}
